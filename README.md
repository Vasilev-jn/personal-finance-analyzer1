# Finance AI Vault (локальное приложение)

Локальный веб‑интерфейс: импортирует CSV из Альфы и Тинькофф, нормализует операции, категоризирует через правила → mapping → ML/LLM‑заглушки и строит аналитику как в банках.

## Запуск

```bash
python -m pip install -r requirements.txt
python app.py  # http://localhost:5000
```

## Как устроено (ядро)

1. **Домен**: `Operation`, `Account`, `Category`, `Vault` (`finance_app/domain.py`).
2. **Категории**: дерево `sys_* → base_*` в `finance_app/category_tree.py` + словарь `CATEGORY_INDEX`.
3. **Импорт**: адаптеры CSV `alfa_adapter.py`, `tinkoff_adapter.py` приводят даты/суммы/валюты, определяют тип INCOME/EXPENSE, создают счета (`Vault.ensure_account`).
4. **Категоризация**: `services/categorization.py` — цепочка правил (`rules.py`) → маппинг `bank_category -> base_*` (`category_mapping.py`) → ML stub (MCC/ключевые слова) → LLM stub (безопасный фолбек).
5. **Хранилище**: все операции кладутся в единый Vault с унифицированными полями.
6. **Аналитика**: `analytics_service.py` считает totals, разрез по sys/base, travel, сервисные операции, месячную динамику, выгрузку датасета для ML.
7. **API/сервер**: `app.py` (Flask) — загрузка файла, демо-импорт всех `operations_*.csv`, выдача аналитики и списка операций.
8. **UI**: `/` рендерит `templates/index.html` с Chart.js, тёмной «банковской» темой (`static/style.css`, `static/app.js`), кнопка демо-импорта и табличка последних операций.

## ML модель (простой baseline)

- Обучение: кнопка «Обучить» в UI или POST `/api/train-ml`. Берём операции с категориями (не сервисные, не `base_unknown`), строим TF-IDF (текст+merchant+bank_category+mcc+bank) и LogisticRegression (scikit-learn).
- Использование: если модель обучена, пайплайн после правил/маппинга использует её как ML-слой. При недостатке данных — остаётся заглушка.
- Метрики: при обучении считаем accuracy и macro-F1 на hold-out (stratify при возможности). См. карточку ML в UI.
- Артефакт: модель можно сохранить/загрузить (joblib). План: `models/expense_clf.pkl`.

## LLM

LLM не участвует в категоризации. Используется как отдельный чат, которому отдаётся готовая аналитика через `/api/agent-context` (totals, breakdown, тренды, unknown). Он может советовать, но не меняет данные напрямую.

## Использование

- Нажмите «Загрузить демо-файлы» для импорта всех `operations_a*.csv` и `operations_t*.csv` в корне. Или загрузите свой CSV, выбрав банк.
- После импорта обновятся карточки доход/расход/нетто, донат и бар‑чарты, табличка операций с источником категоризации.
- Сброс «Сессия» очищает Vault (данные в памяти, диск не трогается).
